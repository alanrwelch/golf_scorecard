<!DOCTYPE html>
<html>
<title>
    ⛳️🏌️‍♂️📝
</title>
<body>
    <h1>
        Springfield Senior League
    </h1>
    <h2>
        <div id="course"></div>
    </h2>

    <div id="table"></div>
    <button onclick="submit()">Submit</button>
</body>
<script>
    const scorecard_config = {
        pars: [2, 3, 4],
        numPlayers: 4,
        courseName: "Green Hill Zone"
    };

    function createScorecard(scorecard_config) {
        document.getElementById("course").textContent = scorecard_config.courseName
        document.getElementById("table").appendChild(generateTable(scorecard_config))

    }

    function generateTable(scorecard_config) {
        const table = document.createElement("table")

        const numHoles = scorecard_config.pars.length

        const nameRow = generateNameRow(scorecard_config.numPlayers)
        table.appendChild(nameRow)

        for (var holeIndex = 0; holeIndex < numHoles; holeIndex++) {
            const row = generateHoleRow(scorecard_config.pars, holeIndex, scorecard_config.numPlayers)
            table.appendChild(row)
        }

        const scoreRow = generateScoreRow(scorecard_config.numPlayers)
        table.appendChild(scoreRow)

        const pointsRow = generatePointsRow(scorecard_config.numPlayers)
        table.appendChild(pointsRow)

        return table
    }

    function generateNameRow(numPlayers) {
        const row = document.createElement("tr")

        const headerCell = document.createElement("td")
        headerCell.textContent = "Name"
        row.appendChild(headerCell)

        for (var playerIndex = 0; playerIndex < numPlayers; playerIndex++) {
            const playerCell = document.createElement("td")

            const input = document.createElement("input")
            input.type = "string"
            input.id = idPlayerName(playerIndex)
            input.placeholder = "Name"

            playerCell.appendChild(input)

            row.appendChild(playerCell)
        }

        return row
    }

    function generateHoleRow(pars, holeIndex, numPlayers) {
        console.log("Generating hole %s", holeIndex)

        const row = document.createElement("tr")

        const headerCell = generateHoleHeader(holeIndex, pars[holeIndex])
        row.appendChild(headerCell)

        for (var playerIndex = 0; playerIndex < numPlayers; playerIndex++) {
            const holeCell = generateHoleForPlayer(pars, holeIndex, playerIndex)
            row.appendChild(holeCell)
        }

        return row
    }

    function generateHoleHeader(holeIndex, par) {
        console.log("Generating hole header %s", holeIndex)

        const cell = document.createElement("td")
        cell.textContent = holeIndex + "/" + par

        return cell
    }

    function generateHoleForPlayer(pars, holeIndex, playerIndex) {
        console.log("Generating hole %s, player %s", holeIndex, playerIndex)

        const cell = document.createElement("td")

        const input = document.createElement("input")
        input.type = "number"
        input.id = idHolePlayer(holeIndex, playerIndex)
        input.placeholder = 0               // Don't set value so unset fields are treated as empty
        input.min = Math.max(pars[holeIndex] - 2, 1)    // At best an Eagle (or hole in 1)
        input.max = pars[holeIndex] + 2                 // At worst, a double-bogey
        input.onchange = function (event) { updateScoreAndPoints(pars, playerIndex) }

        cell.appendChild(input)

        return cell
    }

    function generateScoreRow(numPlayers) {
        const row = document.createElement("tr")

        const headerCell = document.createElement("td")
        headerCell.textContent = "Score"
        row.appendChild(headerCell)

        for (var playerIndex = 0; playerIndex < numPlayers; playerIndex++) {
            const scoreCell = document.createElement("td")

            scoreCell.id = idScorePlayer(playerIndex)
            scoreCell.textContent = 0
            row.appendChild(scoreCell)
        }

        return row
    }

    function generatePointsRow(numPlayers) {
        const row = document.createElement("tr")

        const headerCell = document.createElement("td")
        headerCell.textContent = "Points"
        row.appendChild(headerCell)

        for (var playerIndex = 0; playerIndex < numPlayers; playerIndex++) {
            const pointsCell = document.createElement("td")

            pointsCell.id = idPointsPlayer(playerIndex)
            pointsCell.textContent = 0
            row.appendChild(pointsCell)
        }

        return row
    }

    function updateScoreAndPoints(pars, playerIndex) {
        const score = updateScore(pars.length, playerIndex)
        const points = updatePoints(pars, playerIndex)

        document.getElementById(idScorePlayer(playerIndex)).textContent = score
        document.getElementById(idPointsPlayer(playerIndex)).textContent = points
    }

    function updateScore(numHoles, playerIndex) {
        var total = 0
        for (var holeIndex = 0; holeIndex < numHoles; holeIndex++) {
            const score = parseInt(document.getElementById(idHolePlayer(holeIndex, playerIndex)).value)
            console.log(typeof score)
            if (isNaN(score)) {
                continue
            }
            total += score
        }
        return total
    }

    function updatePoints(pars, playerIndex) {
        var scoresOrNaN = []
        for (var holeIndex = 0; holeIndex < pars.length; holeIndex++) {
            scoresOrNaN.push(parseInt(document.getElementById(idHolePlayer(holeIndex, playerIndex)).value))
        }

        // We need to compute points iff the user has entered a value for the corresponding hole.

        var total = 0
        for (var holeIndex = 0; holeIndex < pars.length; holeIndex++) {
            if (isNaN(scoresOrNaN[holeIndex])) {
                continue
            }

            total += 2 - (scoresOrNaN[holeIndex]- pars[holeIndex])
        }
        return total
    }

    createScorecard(scorecard_config)

    function submit() {
        var playerScores = []

        for (var playerIndex = 0; playerIndex < scorecard_config.numPlayers; playerIndex++) {
            playerScores.push(getPlayerScore(scorecard_config.pars.length, playerIndex))
        }

        alert(JSON.stringify(playerScores))
        // Replace with the call to the AppScript backend.
    }

    function getPlayerScore(numHoles, playerIndex) {
        var out = []

        out.push(document.getElementById(idPlayerName(playerIndex)).value)

        for (var holeIndex = 0; holeIndex < numHoles; holeIndex++) {
            out.push(document.getElementById(idHolePlayer(holeIndex, playerIndex)).value)
        }

        console.log("Score for player %s, %s", playerIndex, out)
        return out
    }

    function idHolePlayer(holeIndex, playerIndex) {
        return holeIndex + "_" + playerIndex
    }

    function idScorePlayer(playerIndex) {
        return "score_" + playerIndex
    }

    function idPointsPlayer(playerIndex) {
        return "points_" + playerIndex
    }

    function idPlayerName(playerIndex) {
        return "name_" + playerIndex
    }
</script>

</html>